<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
    
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Rubic Cube</title>
        <style type="text/css" media="screen">
            body {
                background-color: black;
                color: white;
                font-family:'Lucida Grande', Verdana, Arial;
                font-size: 12px;
                background-image: -webkit-gradient(radial, 50% 500, 1, 50% 500, 400, from(rgba(255, 255, 255, 0.3)), to(rgba(255, 255, 255, 0)));
                background-repeat: no-repeat;
            }
            #container {
                width: 100%;
                height: 700px;
                -webkit-perspective: 800;
                /* For compatibility with iPhone 3.0, we leave off the units here */
                -webkit-perspective-origin: 50% 0%;
            }
            #stage {
                width: 100%;
                height: 100%;
                -webkit-transition: -webkit-transform 2s;
                -webkit-transform-style: preserve-3d;
            }
            #shape {
                position: relative;
                top: 200px;
                margin: 0 auto;
                height: 100px;
                width: 100px;
                border: 1px solid white;
                -webkit-transform-style: preserve-3d;
            }
            .block {
                position: absolute;
                height: 100px;
                width: 100px;
                /*
        border: 1px solid cyan;
*/
                -webkit-transition: -webkit-transform 1s, opacity 2s;
                -webkit-transform-style: preserve-3d;
            }
            .plane {
                position: absolute;
                margin: 2px;
                height: 96px;
                width: 96px;
                -webkit-border-radius: 12px;
                -webkit-box-sizing: border-box;
                text-align: center;
                vertical-align: middle;
                font-family: Times, serif;
                font-size: 24pt;
                color: black;
                opacity:0.8;
                -webkit-transition: -webkit-transform 2s, opacity 2s;
                -webkit-backface-visibility: hidden;
            }
            #shape.backfaces .plane {
                -webkit-backface-visibility: visible;
            }
            #shape {
                /*
        -webkit-animation: spin 32s infinite linear;
        -webkit-transform: rotateY(-30deg);
*/
            }
            @-webkit-keyframes spin {
                from {
                    -webkit-transform: rotateY(0);
                }
                to {
                    -webkit-transform: rotateY(-360deg);
                }
            }
            /* plane colors */
            .plane.yellow {
                background-color: yellow;
            }
            .plane.white {
                background-color: white;
            }
            .plane.blue {
                background-color: blue;
            }
            .plane.green {
                background-color: green;
            }
            .plane.red {
                background-color: red;
            }
            .plane.orange {
                background-color: darkorange;
            }
            .controls {
                width: 80%;
                margin: 0 auto;
                padding: 5px 20px;
                -webkit-border-radius: 12px;
                background-color: rgba(255, 255, 255, 0.5);
            }
            .controls > div {
                margin: 10px;
            }
        </style>
        <script src="jquery-1.7.2.js"></script>
        <script type="text/javascript" charset="utf-8">
            function Matrix(m) {
                this.n = m.length;
                this.m = m; 
            }
            
            Matrix.prototype.multiply = function (xyzt) {
                var result = [];
                for (var i = 0; i < this.n; i ++) {
                    result[i] = 0;
                    for (var j = 0; j < this.n; j ++) {
                        result[i] += this.m[j][i] * xyzt[j];
                    }
                }
                return result;
            }

            Matrix.prototype.toString = function () {
                var i,j;
                var str = '';
                for (var i = 0; i < this.n; i ++) {
                    for (var j = 0; j < this.n; j ++) {
                        str += this.m[i][j];
                        if (i != this.n - 1 || j != this.n - 1) {
                            str += ',';
                        }
                    }
                }
                return str;
            }

            $(document).ready(function () {
                var planes = [
                    [
                        [
                            ['blue', 'yellow', 'orange'], ['', 'yellow', 'orange'], ['green', 'yellow', 'orange'] 
                        ],
                        [
                            ['blue', '', 'orange'], ['', '', 'orange'], ['green', '', 'orange'] 
                        ],
                        [
                            ['blue', 'white', 'orange'], ['', 'white', 'orange'], ['green', 'white', 'orange'] 
                        ] 
                    ],
                    [
                        [
                            ['blue', 'yellow', ''], ['', 'yellow', ''], ['green', 'yellow', ''] 
                        ],
                        [
                            ['blue', '', ''], ['', '', ''], ['green', '', ''] 
                        ],
                        [
                            ['blue', 'white', ''], ['', 'white', ''], ['green', 'white', ''] 
                        ], 
                    ],
                    [
                        [
                            ['blue', 'yellow', 'red'], ['', 'yellow', 'red'], ['green', 'yellow', 'red']
                        ],
                        [
                            ['blue', '', 'red'], ['', '', 'red'], ['green', '', 'red']
                        ],
                        [
                            ['blue', 'white', 'red'], ['', 'white', 'red'], ['green', 'white', 'red']
                        ] 
                    ]
                ];
                var m;
                var x, y, z;
                var i;
                var eBlock, ePlane;
                var plane;
                var blocks = [];
                for (z = 0; z < 3; ++z) {
                    blocks[z] = [];
                    for (y = 0; y < 3; ++y) {
                        blocks[z][y] = [];
                        for (x = 0; x < 3; ++x) {
                            blocks[z][y][x] = {};
                            eBlock = $("<div class='block'/>");
                            for (i = 0; i < 3; i++) {
                                plane = planes[z][y][x][i];

                                eBlock.addClass(plane);

                                ePlane = $("<div class='plane'/>");
                                ePlane.addClass(plane);
                                switch (plane) {
                                case 'green':
                                    m = 'matrix3d(0,0,-1,0,  0,1,0,0,  1,0,0,0,  50,0,0,1)';
                                    break;
                                case 'blue':
                                    m = 'matrix3d(0,0,1,0,  0,1,0,0,  -1,0,0,0,  -50,0,0,1)';
                                    break;
                                case 'white':
                                    m = 'matrix3d(1,0,0,0,  0,0,-1,0,  0,1,0,0,  0,50,0,1)';
                                    break;
                                case 'yellow':
                                    m = 'matrix3d(1,0,0,0,  0,0,1,0,  0,-1,0,0,  0,-50,0,1)';
                                    break;
                                case 'red':
                                    m = 'matrix3d(1,0,0,0,  0,1,0,0,  0,0,1,0,  0,0,50,1)';
                                    break;
                                case 'orange':
                                    m = 'matrix3d(1,0,0,0,  0,1,0,0,  0,0,1,0,  0,0,-50,1)';
                                    break;
                                default:
                                    break;
                                }

                                ePlane.css("-webkit-transform", m);
                                ePlane.appendTo(eBlock);
                            }
                            m = 'matrix3d(1,0,0,0,  0,1,0,0,  0,0,1,0,  ' + (x - 1) * 100 + ',' + (y - 1) * 100 + ',' + (z - 1) * 100 + ',1)';
                            eBlock.css("-webkit-transform", m);
                            eBlock.appendTo("#shape");
                            blocks[z][y][x] = {elem: eBlock, elemPrev: null};
                        }
                    }
                }


                var clicked = false;
                $("#shape").click(function() {
                    if (!clicked) { 
                        //$(".plane").css("-webkit-transform", "matrix3d(1, 0, 0, 0,   0, 1, 0, 0,   0, 0, 1, 0,  0, 0, -50, 1)");
                        var plane = {xyz: 'z', num: 1};
                        var x,y,z;
                        var result;
                        var m, mStr;
                        var matrix = '';
                        switch (plane.xyz) {
                        case 'x':
                            m  = new Matrix([[1,0,0,0], [0,0,-1,0], [0,1,0,0], [0,0,0,1]]);
                            break;
                        case 'y':
                            m = new Matrix([[0,0,-1,0], [0,1,0,0], [1,0,0,0], [0,0,0,1]]);
                            break;
                        case 'z':
                            m = new Matrix([[0,1,0,0], [-1,0,0,0], [0,0,1,0], [0,0,0,1]]);
                            break;
                        }
                    $("#debug").html(m.toString());
                        for (z = -1; z < 2; z ++) {
                            if (plane.xyz === 'z' && plane.num != z) {
                                continue;
                            }
                            for (y = -1; y < 2; y ++) {
                                if (plane.xyz === 'y' && plane.num != y) {
                                    continue;
                                }
                                if (plane.xyz === 'x') {
                                    if (plane.num == x) {
                                        result = m.multiply([z,y,x,1]);
                                        if (blocks[z+1][y+1][x+1].elemPrev) {
                                                blocks[z+1][y+1][x+1].elem = blocks[z+1][y+1][x+1].elemPrev; 
                                                blocks[z+1][y+1][x+1].elemPrev = null;
                                        }
                                        blocks[result[0]+1][result[1]+1][result[2]+1].elemPrev = blocks[result[0]+1][result[1]+1][result[2]+1].elem;
                                        blocks[result[0]+1][result[1]+1][result[2]+1].elem = blocks[z+1][y+1][x+1].elem;
                                        blocks[z+1][y+1][x+1].elem = null;
                                $("#matrix3d").html(result[0] + ',' + result[1] + ',' + result[2]);
                                        $(blocks[result[0]+1][result[1]+1][result[2]+1].elem).css("-webkit-transform", "matrix3d(" + m.toString() + ")");
                                    }
                                } else {
                                    for (x = -1; x < 2; x ++) {
                                        result = m.multiply([x,y,z,1]);
                                        //result = [z,y,x,1];
                                        x2 = x + 1;
                                        y2 = y + 1;
                                        z2 = z + 1;
                                        x3 = result[0] + 1;
                                        y3 = result[1] + 1;
                                        z3 = result[2] + 1;
                                        if (x2 == x3 && y2 == y3 && z2 == z3) {
                                            continue;
                                        }
                                        if (blocks[z2][y2][x2].elemPrev) {
                                                blocks[z2][y2][x2].elem = blocks[z2][y2][x2].elemPrev; 
                                                blocks[z2][y2][x2].elemPrev = null;
                                        }
                                        blocks[z3][y3][x3].elemPrev = blocks[z3][y3][x3].elem; // save the current one
                                        blocks[z3][y3][x3].elem = blocks[z2][y2][x2].elem; // assign the new one
                                        blocks[z2][y2][x2].elem = null;
                                        //matrix += result[0] + 1 + ',' + (result[1] + 1) + ',' + (result[2] + 1) + '<br/>'; 
                                        matrix += x + ',' + y + ',' + z + ' --> ' + result[0]  + ',' + result[1]  + ',' + result[2] + '<br/>'; 
                                        //matrix += (x2) + ',' + (y2) + ',' + (z2) + ' --> ' + x3  + ',' + y3  + ',' + z3 + '<br/>'; 
                                        //if (x2 == 2 && y2 == 2) {
                                            //$("#debug").html("x2,y2,z2: " + x2 + "," + y2 + "," + z2 + " --> " + "x3,y3,z3: " + x3 + "," + y3 + "," + z3);
                                            $("#matrix3d").html(matrix.toString());
                                            mStr = $(blocks[z3][y3][x3].elem).css("-webkit-transform");
                                            $("#debug").html("mStr: " + mStr);
                                            mStr = mStr.replace(/(,[^,]+){4}$/, ',');
                                            mStr += (x3 - 1) * 100 + ',' + (y3 - 1) * 100 + ',' + (z3 - 1) * 100 + ',1)';
                                            mStr += ' ' + 'matrix3d(' + m.toString() + ')';
                                            //$("#matrix3d").html(mStr);
                                            $(blocks[z3][y3][x3].elem).css("-webkit-transform", mStr);
                                        //}
                                    }
                                }
                            }
                        }
                             //   $("#matrix3d").html(matrix);
                        clicked = true;
                    } else {
                        //$(".plane").css("-webkit-transform", "matrix3d(1, 0, 0, 0,   0, 1, 0, 0,   0, 0, 1, 0,  0, 0, 50, 1)");
                        clicked = false;
                    }
                });

                var mousedown = false;
                var x0, y0, x1, y1, dx, dy;
                $("#stage").mousedown(function (ev) {
                    mousedown = true;
                    x0 = ev.pageX;
                    y0 = ev.pageY;
                    $("#debug").html("debug: " + x0 + "," + y0);
                }).mousemove(function (ev) {
                    if (!mousedown) {
                        return;
                    }
                    x1 = ev.pageX;
                    y1 = ev.pageY;
                    dx = x1 - x0;
                    dy = y1 - y0;
                    var m = $("#shape").css("-webkit-transform");
                    if (m === "none") m = '';
                    var w = (dx / 300) * Math.PI;
                    var v = -(dy / 300) * Math.PI;
                    //m += " matrix3d(" + 
                    //    Math.cos(w) + ",    0," +                -Math.sin(w) +               ",0," +  
                    //    "0," +              Math.cos(v) + "," +  Math.sin(v) +               ",0," + 
                    //    Math.sin(w) + "," + -Math.sin(v) + "," +  Math.cos(w) * Math.cos(v) + ",0," + 
                    //    "0, 0, 0, 1)";
                    m += " matrix3d(" + Math.cos(w) + "," + "0," + -Math.sin(w) + "," + "0," + "0," + "1," + "0," + "0," + Math.sin(w) + "," + "0," + Math.cos(w) + "," + "0," + "0, 0, 0, 1)";
                    m += " matrix3d(" + "1," + "0," + "0," + "0," + "0," + Math.cos(v) + "," + Math.sin(v) + "," + "0," + "0," + -Math.sin(v) + "," + Math.cos(v) + "," + "0," + "0, 0, 0, 1)";
                    $("#shape").css("-webkit-transform", m);
                    m = $("#shape").css("-webkit-transform");
                    $("#debug").html("debug: " + x0 + "," + y0 + " " + x1 + "," + y1 + " " + dx + "," + dy);
                    //$("#matrix3d").html(m);

                    x0 = x1;
                    y0 = y1;
                }).mouseup(function (ev) {
                    mousedown = false;
                });

                //var blockCss = $(".block.yellow").css("-webkit-transform");
                //$("#debug").html("debug: " + blockCss);
            });

            function resetShape() {
                //$("#shape").css("-webkit-transition", "-webkit-transform 2s, opacity 2s");
                $("#shape").css("-webkit-transform", 'matrix3d(1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1)');
                //$("#shape").css("-webkit-transition", "");
            }
        </script>
    </head>
    
    <body>
        <div class="controls">
            <h1>Animations, Transitions and 3D Transforms</h1>
            <div>
                <button onclick="resetShape()">Reset</button>
            </div>
            <div>
                <input type="checkbox" id="backfaces" onclick="toggleBackfaces()" checked>
                <label for="backfaces">Backfaces visible</label>
            </div>
            <div style="position:relative">
                <p id="debug">xxx</p>
                <p id="matrix3d" style="position:relative;top:-10px">matrix3d</p>
            </div>
        </div>
        <div id="container">
            <div id="stage">
                <div id="shape" class="cube backfaces">
                </div>
            </div>
        </div>
    </body>

</html>
